<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true">

    <!-- Поддержка расширений Spring Boot: %clr, %wEx и т.п. -->
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

    <!-- ==== Spring/ENV переменные ==== -->
    <springProperty name="APP_NAME" source="spring.application.name" defaultValue="application"/>
    <springProperty name="APP_TZ"   source="app.time.zone"          defaultValue="Europe/Moscow"/>

    <!-- Каталог и имя файла лога -->
    <springProperty name="LOG_DIR"       source="LOG_DIR"       defaultValue="logs"/>
    <springProperty name="LOG_FILE_NAME" source="LOG_FILE_NAME" defaultValue="${APP_NAME}"/>

    <!-- Параметры ротации -->
    <springProperty name="LOG_MAX_FILE_SIZE"  source="LOG_MAX_FILE_SIZE"  defaultValue="50MB"/>
    <springProperty name="LOG_MAX_HISTORY"    source="LOG_MAX_HISTORY"    defaultValue="30"/>
    <springProperty name="LOG_TOTAL_SIZE_CAP" source="LOG_TOTAL_SIZE_CAP" defaultValue="10GB"/>

    <!-- Root level (можно переопределить через logging.level.root) -->
    <springProperty name="ROOT_LEVEL" source="logging.level.root" defaultValue="INFO"/>

    <!-- Можно переопределить паттерны через application.yml -->
    <springProperty name="OVERRIDE_CONSOLE_PATTERN" source="logging.pattern.console"/>
    <springProperty name="OVERRIDE_FILE_PATTERN"    source="logging.pattern.file"/>

    <!-- Параметры асинхронной записи -->
    <springProperty name="ASYNC_QUEUE_SIZE"       source="LOG_ASYNC_QUEUE_SIZE"       defaultValue="8192"/>
    <springProperty name="ASYNC_DISCARD_THRESHOLD" source="LOG_ASYNC_DISCARD_THRESHOLD" defaultValue="0"/>
    <!-- neverBlock=false: не теряем события, но логгер может кратко блокироваться при полном буфере -->
    <springProperty name="ASYNC_NEVER_BLOCK"      source="LOG_ASYNC_NEVER_BLOCK"      defaultValue="false"/>

    <!-- ==== Patterns ==== -->
    <property name="ISO_OFFSET_PATTERN" value="yyyy-MM-dd'T'HH:mm:ss.SSSXXX"/>

    <!-- Консоль: цвета, полный [%thread], выравнивание logger до 40 символов -->
    <property name="CONSOLE_LOG_PATTERN"
              value="%clr(%d{${ISO_OFFSET_PATTERN}, ${APP_TZ}}){faint} %clr(%5p) %clr(${PID:-}){magenta} --- %clr([%thread]){faint} %clr(%-40.40logger{39}){cyan} : %m%n%wEx"/>

    <!-- Файл: без цветов -->
    <property name="FILE_LOG_PATTERN"
              value="%d{${ISO_OFFSET_PATTERN}, ${APP_TZ}} %5p ${PID:-} --- [%thread] %-40.40logger{39} : %m%n%wEx"/>

    <!-- ==== Appenders ==== -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <charset>UTF-8</charset>
            <pattern>${OVERRIDE_CONSOLE_PATTERN:-${CONSOLE_LOG_PATTERN}}</pattern>
        </encoder>
    </appender>

    <!-- Синхронный файловый аппендер (с ротацией) -->
    <appender name="ROLLING" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_DIR}/${LOG_FILE_NAME}.log</file>
        <append>true</append>
        <!-- Меньше syscalls при работе в паре с AsyncAppender -->
        <immediateFlush>false</immediateFlush>

        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <charset>UTF-8</charset>
            <pattern>${OVERRIDE_FILE_PATTERN:-${FILE_LOG_PATTERN}}</pattern>
        </encoder>

        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_DIR}/${LOG_FILE_NAME}-%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>${LOG_MAX_FILE_SIZE}</maxFileSize>
            <maxHistory>${LOG_MAX_HISTORY}</maxHistory>
            <totalSizeCap>${LOG_TOTAL_SIZE_CAP}</totalSizeCap>
            <cleanHistoryOnStart>true</cleanHistoryOnStart>
        </rollingPolicy>
    </appender>

    <!-- Асинхронная обёртка для файла -->
    <appender name="ASYNC_ROLLING" class="ch.qos.logback.classic.AsyncAppender">
        <queueSize>${ASYNC_QUEUE_SIZE}</queueSize>
        <discardingThreshold>${ASYNC_DISCARD_THRESHOLD}</discardingThreshold>
        <neverBlock>${ASYNC_NEVER_BLOCK}</neverBlock>
        <!-- includeCallerData по умолчанию false: не трогаем стек, экономим CPU -->
        <appender-ref ref="ROLLING"/>
    </appender>

    <!-- ==== Loggers ==== -->
    <!-- Уровни пакетов задавайте в application.yml (logging.level.*) -->

    <root level="${ROOT_LEVEL}">
        <appender-ref ref="CONSOLE"/>
        <!-- Пишем в файл через асинхронную обёртку -->
        <appender-ref ref="ASYNC_ROLLING"/>
    </root>
</configuration>
